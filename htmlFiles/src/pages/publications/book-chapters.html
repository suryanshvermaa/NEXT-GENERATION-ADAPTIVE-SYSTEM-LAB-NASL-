<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Chapters</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/people_style.css" />
  </head>
  <body>
    <div id="navbar-placeholder"></div>

    <h1>Book Chapters</h1>

    <div class="container" id="bookChapterContainer"></div>

    <a
      href="../forms_html/book-chapter.html"
      id="addButton"
      class="btn btn-success mx-auto mb-4"
      style="max-width: 240px; display: none"
    >
      + Add Book Chapter
    </a>

    <div id="footer-placeholder"></div>

    <script src="../js/navbar.js"></script>
    <script src="../js/footer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/publicationCRUD.js"></script>
    <script src="/js/publicationUI.js"></script>

    <script>
      const container = document.getElementById("bookChapterContainer");
      const type = "bookChapter";

      const token = localStorage.getItem("authToken");
      let userRole = null;
      document.getElementById("addButton").style.display = token ? "block" : "none";

      let currentUserId = null;
      try {
        const userData = JSON.parse(localStorage.getItem("user"));
        currentUserId = userData?.id || null;
        userRole = userData?.role || null;
      } catch {
        currentUserId = null;
      }

      const isAdmin = userRole === "ADMIN";

      const pubCRUD = new PublicationCRUD();
      const pubUI = new PublicationUI(pubCRUD);

      let currentPage = 1;
      const limit = 10;
      let bookChapterById = new Map();

      window.loadAllPublications = function () {
        fetchBookChapters(currentPage);
      };

      function showEmptyState() {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; border: 2px dashed #dee2e6; border-radius: 12px; background: #f8f9fa;">
            <i class="fas fa-book" style="font-size: 48px; color: #adb5bd; margin-bottom: 16px;"></i>
            <p style="color: #6c757d; font-size: 18px; margin: 0;">No book chapters available</p>
          </div>
        `;
      }

      function fetchBookChapters(page = 1) {
        currentPage = page;
        container.innerHTML = '<p>Loading...</p>';
        bookChapterById = new Map();

        const url = currentUserId
          ? `${window.NASL.API_BASE}/api/book-chapter/get-all-by-user-id/${encodeURIComponent(
              currentUserId
            )}?page=${page}&limit=${limit}`
          : `${window.NASL.API_BASE}/api/book-chapter/get-all?page=${page}&limit=${limit}`;

        fetch(url)
          .then(async (response) => {
            if (response.status === 404) {
              showEmptyState();
              return null;
            }
            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              throw new Error(err.message || "Failed to fetch book chapters");
            }
            return response.json();
          })
          .then((result) => {
            if (!result) return;
            const { bookChapters } = result.data;

            if (!bookChapters || bookChapters.length === 0) {
              showEmptyState();
              return;
            }

            container.innerHTML = "";

            bookChapters.forEach((chapter) => {
              bookChapterById.set(String(chapter.id), chapter);

              const card = document.createElement("div");
              card.className = "card";

              const authorsDisplay = Array.isArray(chapter.authors)
                ? chapter.authors
                    .map((a) => (typeof a === "string" ? a : a?.name || a))
                    .join(", ")
                : chapter.authors || "N/A";

              const canMutateItem = Boolean(token) && (isAdmin || (currentUserId != null && Number(chapter.createdBy) === Number(currentUserId)));
              const actions = canMutateItem
                ? `
                <div class="card-icons">
                  <a class="icon-btn edit-btn" data-id="${chapter.id}" title="Edit">
                    <span class="material-symbols-outlined">edit_document</span>
                  </a>
                  <a class="icon-btn delete-btn" data-id="${chapter.id}" title="Delete">
                    <span class="material-symbols-outlined">delete</span>
                  </a>
                </div>
              `
                : "";

              card.innerHTML = `
                <h5 style="margin-bottom: 20px; color: #1a1a1a; font-weight: 600;">
                  <i class="fas fa-book-open" style="margin-right: 8px; color: #0d6efd;"></i>
                  ${chapter.chapterTitle || "Untitled Chapter"}
                </h5>
                <p style="margin-bottom: 12px; color: #495057;">
                  <i class="fas fa-book" style="margin-right: 8px; color: #6c757d;"></i>
                  <strong>Book:</strong> ${chapter.bookTitle || "N/A"}
                </p>
                <p style="margin-bottom: 12px; color: #495057;">
                  <i class="fas fa-users" style="margin-right: 8px; color: #6c757d;"></i>
                  <strong>Authors:</strong> ${authorsDisplay}
                </p>
                ${chapter.publisher ? `
                  <p style="margin-bottom: 12px; color: #495057;">
                    <i class="fas fa-building" style="margin-right: 8px; color: #6c757d;"></i>
                    <strong>Publisher:</strong> ${chapter.publisher}
                  </p>
                ` : ""}
                ${chapter.year ? `
                  <p style="margin-bottom: 12px; color: #495057;">
                    <i class="fas fa-calendar" style="margin-right: 8px; color: #6c757d;"></i>
                    <strong>Year:</strong> ${chapter.year}
                  </p>
                ` : ""}
                ${chapter.doi ? `
                  <p style="margin-bottom: 0; color: #495057;">
                    <i class="fas fa-link" style="margin-right: 8px; color: #6c757d;"></i>
                    <strong>DOI:</strong>
                    <a href="https://doi.org/${chapter.doi}" target="_blank" style="color: #0d6efd; text-decoration: none;">${chapter.doi}</a>
                  </p>
                ` : ""}
                ${actions}
              `;

              container.appendChild(card);
            });

            const paginationDiv = document.createElement("div");
            paginationDiv.className =
              "pagination-controls d-flex justify-content-between align-items-center mt-4";
            paginationDiv.innerHTML = `
              <button id="prevBtn" class="btn btn-outline-primary" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <span class="text-muted">Page ${currentPage}</span>
              <button id="nextBtn" class="btn btn-outline-primary" ${bookChapters.length < limit ? 'disabled' : ''}>
                Next <i class="fas fa-chevron-right"></i>
              </button>
            `;
            container.appendChild(paginationDiv);

            document.getElementById("prevBtn")?.addEventListener("click", () => {
              if (currentPage > 1) {
                fetchBookChapters(currentPage - 1);
                window.scrollTo({ top: 0, behavior: "smooth" });
              }
            });

            document.getElementById("nextBtn")?.addEventListener("click", () => {
              if (bookChapters.length >= limit) {
                fetchBookChapters(currentPage + 1);
                window.scrollTo({ top: 0, behavior: "smooth" });
              }
            });

            if (token) {
              document.querySelectorAll(".delete-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                  const id = this.getAttribute("data-id");
                  const item = bookChapterById.get(String(id));
                  const allowed = isAdmin || (currentUserId != null && Number(item?.createdBy) === Number(currentUserId));
                  if (!allowed) {
                    alert("You are not authorized to delete this book chapter.");
                    return;
                  }
                  pubUI.confirmDelete(type, id, item?.chapterTitle || "Book Chapter");
                });
              });

              document.querySelectorAll(".edit-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                  const id = this.getAttribute("data-id");
                  const item = bookChapterById.get(String(id));
                  if (!item) return;
                  const allowed = isAdmin || (currentUserId != null && Number(item?.createdBy) === Number(currentUserId));
                  if (!allowed) {
                    alert("You are not authorized to edit this book chapter.");
                    return;
                  }
                  pubUI.showEditModal(type, id, item);
                });
              });
            }
          })
          .catch((error) => {
            console.error("Error loading book chapters:", error);
            container.innerHTML = `
              <div style="text-align: center; padding: 60px 20px; border: 2px dashed #dee2e6; border-radius: 12px; background: #f8f9fa;">
                <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #dc3545; margin-bottom: 16px;"></i>
                <p style="color: #6c757d; font-size: 18px; margin: 0;">${error.message}</p>
              </div>
            `;
          });
      }

      fetchBookChapters(1);
    </script>
  </body>
</html>
