<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="../css/people_style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Arvo&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h2 class="">Add Patent</h2>

    <form action="" method="" onsubmit="submitForm(event)">
      <label for="title">Title:</label>
      <input
        type="text"
        id="title"
        name="title"
        required
        placeholder="Enter Patent Title"
      />

      <label for="type">Type:</label>
      <input
        type="text"
        id="type"
        name="type"
        placeholder="Enter Patent Type (optional)"
      />

      <label for="grantNo">Grant Number:</label>
      <input
        type="text"
        id="grantNo"
        name="grantNo"
        placeholder="Enter Grant Number (optional)"
      />

      <label for="grantDate">Grant Date:</label>
      <input
        type="date"
        id="grantDate"
        name="grantDate"
        placeholder="Enter Grant Date (optional)"
      />

      <label for="publicationDate">Publication Date:</label>
      <input
        type="date"
        id="publicationDate"
        name="publicationDate"
        placeholder="Enter Publication Date (optional)"
      />

      <label for="inventorSearch">Add Inventors:</label>
      <input
        type="text"
        id="inventorSearch"
        placeholder="Search by email or name"
      />
      <ul id="searchResults" class="list-group"></ul>

      <!-- Selected inventors will be shown here -->
      <div id="selectedInventors" class="mt-2 mb-2"></div>
      <input type="hidden" id="inventors" name="inventors" />

      <button type="submit">Submit</button>
    </form>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
      integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
      crossorigin="anonymous"
    ></script>

    <script src="/js/config.js"></script>

    <script>
      // Store selected inventor IDs
      const token = localStorage.getItem("authToken");
      const selectedInventors = new Set();
      const userData = JSON.parse(localStorage.getItem("user"));
      const userId = userData?.id;

      // Assume current user ID is available (replace with actual logic)
      const currentUserId = userId; // Example, replace with actual logged-in user ID
      selectedInventors.add(currentUserId); // Add self by default
      updateSelectedInventorsDisplay();

      document.getElementById("inventorSearch").addEventListener(
        "input",
        debounce(async function () {
          const query = this.value.trim();
          const resultList = document.getElementById("searchResults");
          resultList.innerHTML = "";

          if (query.length < 2) return;

          try {
            const res = await fetch(
              `${window.NASL.API_BASE}/api/user/search?query=${encodeURIComponent(query)}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );
            console.log(query);

            if (!res.ok) throw new Error("User search failed");
            const result = await res.json();
            const data = result.data;
            console.log(data);

            if (!data.users.length) {
              const li = document.createElement("li");
              li.className = "list-group-item text-muted";
              li.textContent = "No users found.";
              resultList.appendChild(li);
              return;
            }

            data.users.forEach((user) => {
              if (selectedInventors.has(user.id)) return;

              const li = document.createElement("li");
              li.className =
                "list-group-item d-flex justify-content-between align-items-center";

              li.innerHTML = `
          <span>
            <img src="${
              user.profileImage || "https://via.placeholder.com/30"
            }" class="rounded-circle me-2" width="30" height="30">
            ${user.name} (${user.email})
          </span>
          <button class="btn btn-sm btn-success">Add</button>
        `;

              li.querySelector("button").addEventListener("click", () => {
                selectedInventors.add(user.id);
                updateSelectedInventorsDisplay();
                resultList.innerHTML = "";
                document.getElementById("inventorSearch").value = "";
              });

              resultList.appendChild(li);
            });
          } catch (err) {
            console.error("Error fetching users:", err);
          }
        }, 300)
      );

      function updateSelectedInventorsDisplay() {
        const container = document.getElementById("selectedInventors");
        const inventorsInput = document.getElementById("inventors");
        container.innerHTML = "";

        selectedInventors.forEach((id) => {
          const tag = document.createElement("span");
          tag.className =
            "badge bg-primary me-2 d-inline-flex align-items-center";
          tag.style.padding = "0.5em 0.75em";
          tag.style.fontSize = "0.9em";

          tag.innerHTML = `
          User ID: ${id}
          <button class="btn-close btn-close-white ms-2" aria-label="Remove" style="font-size: 0.6em;"></button>
        `;

          tag.querySelector("button").addEventListener("click", () => {
            selectedInventors.delete(id);
            updateSelectedInventorsDisplay();
          });

          container.appendChild(tag);
        });

        // Update hidden input
        inventorsInput.value = JSON.stringify(Array.from(selectedInventors));
      }

      // (for debounce)
      function debounce(func, delay) {
        let timeout;
        return function () {
          const context = this,
            args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }
    </script>
    <script>
      async function submitForm(e) {
        e.preventDefault();

        const token = localStorage.getItem("authToken");
        const title = document.getElementById("title").value;
        const type = document.getElementById("type").value || null;
        const grantNo = document.getElementById("grantNo").value || null;
        const grantDate = document.getElementById("grantDate").value || null;
        const publicationDate = document.getElementById("publicationDate").value || null;
        const inventors = JSON.parse(document.getElementById("inventors").value);

        // Convert array of inventor IDs to comma-separated string
        const inventorsList = Array.from(inventors).join(",");

        const payload = {
          title,
          type,
          grantNo,
          grantDate,
          publicationDate,
          inventors: inventorsList,
        };

        console.log(payload)
        try {
          const response = await fetch(
            `${window.NASL.API_BASE}/api/patent/create`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          const result = await response.json();

          if (response.ok) {
            console.log(result);
            alert("Patent added successfully!");
            window.location.reload();
          } else {
            alert(result.message || "Failed to create patent");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Something went wrong!");
        }
      }
    </script>
  </body>
</html>
