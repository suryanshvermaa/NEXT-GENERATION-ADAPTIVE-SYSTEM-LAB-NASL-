<!DOCTYPE html>
<html>
  <head>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/people_style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Arvo&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    <h2 class="">Events</h2>
    
    <form action="" method="" onsubmit="submitForm(event)">
     <label for="event">Event Title:</label>
     <input type="text" id="event" name="event" required placeholder="Enter Event Title">
     
     <label for="img">Upload Image:</label>
     <label for="file-upload" class="custom-file-upload">Choose File</label>
     <input id="file-upload" type="file" required>
     <span id="file-name" style="margin-top: 8px; font-size: 14px; color: #333;"></span>
     
     <label for="text">Description:</label>
    <!-- Formatter -->
        <div class="formatter">
          <div id="toolbar">
              <select class="ql-header">
                <option value="1"></option>
                <option value="2"></option>
                <option selected></option>
              </select>
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
              <button class="ql-link"></button>
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
                <!-- Color pickers -->
                <select class="ql-color"></select>
                <select class="ql-background"></select>

              <button class="ql-clean"></button>
          </div>
        <!-- Editor (div) -->
            <div id="editor" style="height: 150px;"></div>
            <textarea name="content" id="hiddenArea" style="display:none;"></textarea>
          <button type="submit">Submit</button>
          </div>
      </form>


<!-- Quill Script -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="../js/quill.js"></script>
<script src="../js/file.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
      integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
      crossorigin="anonymous"></script>

    <script src="/js/config.js"></script>
    <script src="/js/navbar.js"></script>

    <script>
      async function submitForm(e) {
        e.preventDefault();

        const token = localStorage.getItem("authToken");
        const event = document.getElementById("event").value.trim();
        const description = quill.root.innerHTML;
        const file = document.getElementById("file-upload").files[0];
        
        let imageURL = "";

        if (!token) {
          alert("Unauthorized. Please login.");
          return;
        }

        if (!file) {
          alert("Please upload an image.");
          return;
        }

        try {
          // 1. Get the upload URL
          const uploadRes = await fetch(
            `${window.NASL.API_BASE}/api/image/uploadURL`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ imageName: file.name }),
            }
          );

          const res = await uploadRes.json();
          const data = res.data;

          console.log(data);
          const { imageUploadingUrl, imageUrl } = data;

          // 2. Upload the image to the upload URL
          await fetch(imageUploadingUrl, {
            method: "PUT",
            headers: {
              "Content-Type": file.type,
            },
            body: file,
          });
          imageURL = imageUrl;
        } catch (error) {
          console.error("Image upload failed:", error);
          alert("Failed to upload image.");
          return;
        }

        // 3. Create event with image URL
        const payload = {
          event,
          description,
          imageURL,
        };

        try {
          const response = await fetch(
            `${window.NASL.API_BASE}/api/event/create`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(payload),
            }
          );
          const result = await response.json();

          if (response.ok) {
            console.log(result);
            alert("Event created successfully!");
            window.location.reload();
          } else {
            alert(result.message || "Failed to create event.");
          }
        } catch (error) {
          console.error("Event creation failed:", error);
          alert("Something went wrong.");
        }
      }
    </script>

  </body>
</html>