<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/css/people_style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Arvo&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <h2 class="">Fill User Details</h2>

    <form action="" method="" onsubmit="submitForm(event)">
      <!-- Image -->
      <label for="img">Profile Image:</label>
      <label for="file-upload" class="custom-file-upload">Choose File</label>
      <input id="file-upload" type="file" required />
      <span
        id="file-name"
        style="margin-top: 8px; font-size: 14px; color: #333"
      ></span>

      <!-- Name Input -->
      <label for="name">Name:</label>
      <input
        type="text"
        id="name"
        name="name"
        required
        placeholder="Enter your name"
      />

      <label for="designation">Designation:</label>
      <select id="designation" name="designation" required>
        <option value="">Select your designation</option>
        <option value="PhD">PhD</option>
        <option value="MTech">MTech</option>
        <option value="BTech">BTech</option>
        <option value="Intern">Intern</option>
        <option value="Alumni">Alumni</option>
        <option value="Investigator">Investigator</option>
      </select>

      <label for="name">Email:</label>
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder="Enter your email"
      />

      <label for="name">Password:</label>
      <input
        type="password"
        id="password"
        name="password"
        required
        placeholder="Enter your password"
      />

      <button type="submit" id="submitBtn">Submit</button>
    </form>

    <!-- Loading modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body d-flex align-items-center gap-3">
            <div class="spinner-border" role="status" aria-hidden="true"></div>
            <div>
              <div class="fw-semibold" id="loadingTitle">Creating...</div>
              <div class="text-muted" style="font-size: 0.95rem" id="loadingSubtitle">Please wait, don't close this page.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="../js/file.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
      integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
      crossorigin="anonymous"
    ></script>
    <script src="/js/config.js"></script>

    <script>
      // 1. Get the upload URL
      async function submitForm(e) {
        e.preventDefault();

        const submitBtn = document.getElementById("submitBtn");
        const loadingEl = document.getElementById("loadingModal");
        const loadingTitle = document.getElementById("loadingTitle");
        const loadingSubtitle = document.getElementById("loadingSubtitle");
        const loadingModal = loadingEl ? new bootstrap.Modal(loadingEl) : null;

        const setLoading = (title, subtitle) => {
          if (loadingTitle) loadingTitle.textContent = title;
          if (loadingSubtitle) loadingSubtitle.textContent = subtitle;
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Creating...";
          }
          loadingModal?.show();
        };

        const clearLoading = () => {
          loadingModal?.hide();
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
          }
        };

        const token = localStorage.getItem("authToken"); // assuming you're using token auth
        const name = document.getElementById("name").value.trim();
        const designation = document.getElementById("designation").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        const file = document.getElementById("file-upload").files[0];
        let profileImg = "";

        if (!token) {
          if (!token) {
            alert("Unauthorized. Only admin can create users.");
            return;
          }
        }

        if (!file) {
          alert("Please upload an image.");
          return;
        } else {
          try {
            setLoading("Uploading image...", "Preparing profile image upload");
            // 1. Get the upload URL
            const uploadRes = await fetch(
              `${window.NASL.API_BASE}/api/image/uploadURL`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ imageName: file.name }),
              }
            );

            const res = await uploadRes.json();
            const data = res.data;

            console.log(data);
            const { imageUploadingUrl, imageUrl } = data;

            // 2. Upload the image to the upload URL
            setLoading("Uploading image...", "Uploading file to storage");
            await fetch(imageUploadingUrl, {
              method: "PUT",
              headers: {
                "Content-Type": file.type,
              },
              body: file,
            });
            profileImg = imageUrl;
          } catch (error) {
            console.error("Image upload failed:", error);
            clearLoading();
            alert("Failed to upload image.");
            return;
          }
        }
        // 3: Create user with image URL
        const payload = {
          name,
          designation,
          email,
          password,
          profileImage: profileImg,
          role: "USER",
        };
        try {
          setLoading("Creating account...", "Saving user details and sending email");
          const res = await fetch(
            `${window.NASL.API_BASE}/api/user/createUser`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(payload),
            }
          );
          const result = await res.json().catch(() => ({}));

          if (res.ok) {
            console.log(result);
            clearLoading();
            const warning = result?.data?.emailWarning;
            if (warning) {
              alert(`User created successfully, but email failed: ${warning}`);
            } else {
              alert("User created successfully!");
            }
            window.location.reload();
          } else {
            clearLoading();
            const msg = result?.message || "Failed to create user.";
            alert(`Create user failed (HTTP ${res.status}): ${msg}`);
          }
        } catch (error) {
          console.error("User creation failed:", error);
          clearLoading();
          alert("Something went wrong.");
        }
      }
    </script>
  </body>
</html>
